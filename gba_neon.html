<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Neon GBA Emulator</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
/* MATRIX NEON THEME â€” ALL SCOPED TO #gba_ wrapper */
body {
    background: #000;
    margin: 0;
    font-family: Consolas, monospace;
    display: flex;
    justify-content: center;
    align-items: center;
    height: 100vh;
}

#gba_wrapper {
    text-align: center;
    color: #00ff88;
    text-shadow: 0 0 8px #00ff55;
}

#gba_screen {
    width: 720px;
    height: 480px;
    background: #001100;
    border: 4px solid #00ff55;
    box-shadow: 0 0 20px #00ff55, inset 0 0 20px #003300;
    image-rendering: pixelated;
}

.gba_button {
    background: transparent;
    border: 1px solid #00ff55;
    padding: 8px 14px;
    margin: 4px;
    cursor: pointer;
    color: #00ff55;
    font-size: 14px;
    border-radius: 6px;
    transition: 0.2s;
}
.gba_button:hover { box-shadow: 0 0 10px #00ff55; }

#gba_controls {
    margin-top: 12px;
}

/* Modal for key remapping */
#gba_keymap_modal {
    position: fixed;
    top: 50%; left: 50%;
    transform: translate(-50%,-50%);
    background: #001800;
    padding: 20px;
    border: 2px solid #00ff55;
    box-shadow: 0 0 20px #00ff55;
    display: none;
}
</style>
</head>

<body>
<div id="gba_wrapper">

    <canvas id="gba_screen"></canvas>

    <div id="gba_controls">
        <button class="gba_button" id="gba_load_bios">Load BIOS</button>
        <button class="gba_button" id="gba_load_rom">Load ROM</button>
        <button class="gba_button" id="gba_pause">Pause</button>
        <button class="gba_button" id="gba_ff">Fast Forward</button>
        <button class="gba_button" id="gba_rewind">Rewind</button>
        <button class="gba_button" id="gba_save_export">Download Save</button>
        <button class="gba_button" id="gba_controls_edit">Edit Controls</button>
    </div>

    <input type="file" id="gba_fileinput" style="display:none" />
    <input type="file" id="gba_biosinput" style="display:none" />

    <div id="gba_keymap_modal">
        <h3>Remap Controls</h3>
        <div id="gba_keymap_list"></div>
        <button class="gba_button" onclick="document.getElementById('gba_keymap_modal').style.display='none'">Close</button>
    </div>

</div>

<script>
// ======================
// LOAD mGBA CORE
// ======================
let gba = null;
let biosLoaded = false;
let romLoaded = false;
let fastForward = false;
let rewinding = false;
let rewindBuffer = [];

(async () => {
    const module = await import("./js/mgba.js");
    gba = await module.default({
        wasmPath: "./js/mgba.wasm",
        canvas: document.getElementById("gba_screen")
    });
})();

// ======================
// FILE LOADERS
// ======================
document.getElementById("gba_load_bios").onclick = () =>
    document.getElementById("gba_biosinput").click();

document.getElementById("gba_biosinput").onchange = async (e) => {
    const data = new Uint8Array(await e.target.files[0].arrayBuffer());
    gba.setBIOS(data);
    biosLoaded = true;
};

document.getElementById("gba_load_rom").onclick = () =>
    document.getElementById("gba_fileinput").click();

document.getElementById("gba_fileinput").onchange = async (e) => {
    const data = new Uint8Array(await e.target.files[0].arrayBuffer());
    gba.loadROM(data);
    romLoaded = true;
    gba.run();
};

// ======================
// BASIC CONTROLS
// ======================
document.getElementById("gba_pause").onclick = () => {
    if (!romLoaded) return;
    if (gba.running) gba.pause();
    else gba.run();
};

document.getElementById("gba_ff").onclick = () => {
    fastForward = !fastForward;
    gba.setSpeed(fastForward ? 2.5 : 1.0);
};

document.getElementById("gba_rewind").onclick = () => {
    rewinding = !rewinding;
    // TODO: store / replay rewindBuffer frames here
};

// ======================
// SAVE EXPORT
// ======================
document.getElementById("gba_save_export").onclick = () => {
    const sav = gba.getSaveFile();
    const blob = new Blob([sav], {type: "application/octet-stream"});
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = "game.sav";
    a.click();
};

// ======================
// CONTROL REMAPPING UI
// ======================
document.getElementById("gba_controls_edit").onclick = () => {
    document.getElementById("gba_keymap_modal").style.display = "block";
};
</script>

</body>
</html>
